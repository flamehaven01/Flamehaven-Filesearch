name: Document Drift Validation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.md'
      - 'flamehaven_filesearch/**'
      - '.github/workflows/doc-drift.yml'
  pull_request:
    paths:
      - '**.md'
      - 'flamehaven_filesearch/**'
  workflow_dispatch:

jobs:
  validate-drift:
    runs-on: ubuntu-latest
    name: Validate Documentation Drift

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # No external dependencies needed for drift validator

      - name: Run document drift validation
        run: |
          python tools/drift_validator.py \
            --project-root . \
            --report .audit/doc_drift_report.json

      - name: Check documentation health
        id: check_health
        run: |
          python << 'EOF'
          import json
          import sys

          # Read the report
          with open('.audit/doc_drift_report.json', 'r') as f:
              report = json.load(f)

          metrics = report['metrics']
          readme_score = metrics['readme_score']
          coherence_score = metrics['coherence_score']
          errors = len(metrics['errors'])
          warnings = len(metrics['warnings'])

          # Print metrics for display
          print(f"::notice title=Documentation Metrics::README Score: {readme_score:.1%}")
          print(f"::notice title=Documentation Metrics::Coherence Score: {coherence_score:.1%}")

          # Fail if thresholds not met
          failed = False

          if readme_score < 0.6:
              print(f"::error::README score {readme_score:.1%} below 60% threshold")
              failed = True

          if errors > 3:
              print(f"::error::Too many broken links ({errors} > 3)")
              failed = True

          if warnings > 20:
              print(f"::warning::Documentation has {warnings} warnings (threshold: 20)")

          # Set output for next steps
          print(f"readme_score={readme_score:.2%}" >> $GITHUB_OUTPUT)
          print(f"coherence_score={coherence_score:.2%}" >> $GITHUB_OUTPUT)
          print(f"failed={failed}" >> $GITHUB_OUTPUT)

          sys.exit(1 if failed else 0)
          EOF

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: doc-drift-report
          path: .audit/doc_drift_report.json
          retention-days: 30

      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('.audit/doc_drift_report.json', 'utf8'));
            const metrics = report.metrics;

            const body = `## Documentation Drift Validation

            **Metrics:**
            - README Score: \`${(metrics.readme_score * 100).toFixed(1)}%\`
            - Coherence Score: \`${(metrics.coherence_score * 100).toFixed(1)}%\`
            - Broken Links: \`${metrics.errors.length}\`
            - Warnings: \`${metrics.warnings.length}\`

            **Thresholds:**
            - README Score: \`≥ 60%\`
            - Broken Links: \`≤ 3\`
            - Warnings: \`≤ 20\`

            ${ metrics.errors.length > 0 ? `\n**Errors:**\n${metrics.errors.map(e => `- ${e}`).join('\n')}` : '' }
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  summary:
    runs-on: ubuntu-latest
    name: Documentation Validation Summary
    if: always()
    needs: validate-drift

    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate-drift.result }}" = "failure" ]; then
            echo "::error::Document drift validation failed"
            exit 1
          else
            echo "::notice::Document drift validation passed"
          fi
