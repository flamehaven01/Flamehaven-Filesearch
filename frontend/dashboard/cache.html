<!DOCTYPE html>
<html class="dark" lang="en"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Filesearch Ops - Cache</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#137fec",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
            "surface-dark": "#1d2833",
            "border-dark": "#324d67",
            "text-main-dark": "#e1eaf2",
            "text-secondary-dark": "#92adc9",
            "success": "#38A169",
            "error": "#E53E3E"
          },
          fontFamily: { "display": ["Inter", "sans-serif"] },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-main-dark">
  <div class="flex min-h-screen">
    <!-- SideNavBar -->
    <aside class="flex h-screen flex-col justify-between bg-surface-dark/50 p-4 w-64 border-r border-border-dark">
      <div class="flex flex-col gap-4">
        <div class="flex gap-3 items-center">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="Abstract gradient logo" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBSRe6aCEChDJPLBphsa_t4GP2ZvVu3tM8PNvFwl9_dQcjWaApcFbSxpGk8cKF-vMPaRJtNKPbzJSt90jrRkZw3qaeXHGCzIpHphbveA5bxqwptT09kgOBX6ZvriZoSx0WFFnzYdPFjLVk_EDGx-FX0lBE9JWaxw54pm9S1f8KgLJM9pWJYxF84dc3Votj9PX142Nlehglwp7Ior5rvBPuj2Ct_kPJu_oTQOseOb6w-aZQvgd36Tk-rtk5kbvvT1WiKETu0_QAYF9s");'></div>
          <div class="flex flex-col">
            <h1 class="text-text-main-dark text-base font-medium leading-normal">Filesearch Ops</h1>
            <p class="text-text-secondary-dark text-sm font-normal leading-normal">Cache</p>
          </div>
        </div>
        <nav class="flex flex-col gap-2 mt-4">
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="landing_new.html">
            <span class="material-symbols-outlined">dashboard</span>
            <p class="text-sm font-medium leading-normal">Dashboard</p>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="search_new.html">
            <span class="material-symbols-outlined">search</span>
            <p class="text-sm font-medium leading-normal">Search</p>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="upload_new.html">
            <span class="material-symbols-outlined">upload_file</span>
            <p class="text-sm font-medium leading-normal">Upload</p>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-primary" href="cache_new.html">
            <span class="material-symbols-outlined">hub</span>
            <p class="text-sm font-medium leading-normal">Cache</p>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="metrics_new.html">
            <span class="material-symbols-outlined">monitoring</span>
            <p class="text-sm font-medium leading-normal">Metrics</p>
          </a>
          <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="admin.html">
            <span class="material-symbols-outlined">admin_panel_settings</span>
            <p class="text-sm font-medium leading-normal">Admin</p>
          </a>
        </nav>
      </div>
      <div class="flex flex-col gap-1">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="https://github.com/flamehaven01/Flamehaven-Filesearch" title="Open docs/help">
          <span class="material-symbols-outlined">help</span>
          <p class="text-sm font-medium leading-normal">Help</p>
        </a>
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-text-secondary-dark hover:bg-surface-dark" href="landing_new.html">
          <span class="material-symbols-outlined">logout</span>
          <p class="text-sm font-medium leading-normal">Logout</p>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
      <div class="mx-auto max-w-7xl">
        <!-- PageHeading -->
        <header class="flex flex-wrap justify-between items-center gap-3 mb-6">
          <h1 class="text-text-main-dark text-4xl font-black leading-tight tracking-[-0.033em]">Cache Monitor</h1>
        </header>
        <!-- Cache body -->
        <div class="flex items-center gap-3 mb-4">
          <input id="cacheToken" class="h-10 rounded-lg bg-[#233648] text-white text-sm px-3 border border-[#324d67]" placeholder="Bearer token" />
          <button id="btn-refresh-cache" class="flex h-10 items-center rounded-lg bg-primary px-4 text-sm font-bold text-white gap-2 hover:bg-primary/80">
            <span class="material-symbols-outlined">refresh</span>
            <span>Refresh</span>
          </button>
          <button id="btn-flush-cache" class="flex h-10 items-center rounded-lg bg-[#233648] px-4 text-sm font-bold text-white gap-2 hover:bg-[#1c2a35]">
            <span class="material-symbols-outlined">delete</span>
            <span>Flush</span>
          </button>
        </div>
        <div class="grid grid-cols-1 gap-4 py-6 sm:grid-cols-2 lg:grid-cols-4">
          <div class="flex flex-1 flex-col gap-2 rounded-lg border border-[#324d67] bg-[#111a22]/50 p-6">
            <p class="text-white text-base font-medium leading-normal">Cache Hit Rate</p>
            <p id="hitRate" class="text-white tracking-light text-3xl font-bold leading-tight">--</p>
          </div>
          <div class="flex flex-1 flex-col gap-2 rounded-lg border border-[#324d67] bg-[#111a22]/50 p-6">
            <p class="text-white text-base font-medium leading-normal">Memory Used</p>
            <p id="memUsed" class="text-white tracking-light text-3xl font-bold leading-tight">--</p>
          </div>
          <div class="flex flex-1 flex-col gap-2 rounded-lg border border-[#324d67] bg-[#111a22]/50 p-6">
            <p class="text-white text-base font-medium leading-normal">Keys Cached</p>
            <p id="keysCached" class="text-white tracking-light text-3xl font-bold leading-tight">--</p>
          </div>
          <div class="flex flex-1 flex-col gap-2 rounded-lg border border-[#324d67] bg-[#111a22]/50 p-6">
            <p class="text-white text-base font-medium leading-normal">TTL</p>
            <p id="ttlSeconds" class="text-white tracking-light text-3xl font-bold leading-tight">--</p>
          </div>
        </div>
        <div class="mt-6 p-4 rounded-lg border border-[#324d67] bg-[#1a202c] text-white text-sm">
          <p class="text-[#92adc9]">GET /api/metrics -> cache stats, POST /api/admin/cache/flush to clear caches (admin-only).</p>
          <p id="cacheStatus" class="text-sm text-text-secondary-dark mt-2"></p>
        </div>
      </div>
    </main>
  </div>
  <script>
    (() => {
      const tokenEl = document.getElementById("cacheToken");
      const hitRateEl = document.getElementById("hitRate");
      const memUsedEl = document.getElementById("memUsed");
      const keysEl = document.getElementById("keysCached");
      const ttlEl = document.getElementById("ttlSeconds");
      const statusEl = document.getElementById("cacheStatus");
      const btnRefresh = document.getElementById("btn-refresh-cache");
      const btnFlush = document.getElementById("btn-flush-cache");

      const headers = () => (tokenEl?.value ? { Authorization: `Bearer ${tokenEl.value}` } : {});

      const refresh = async () => {
        hitRateEl.textContent = "--";
        memUsedEl.textContent = "--";
        keysEl.textContent = "--";
        ttlEl.textContent = "--";
        statusEl.textContent = "";
        try {
          const resp = await fetch("/api/metrics", { headers: headers() });
          if (!resp.ok) throw new Error(resp.statusText);
          const data = await resp.json();
          const cache = (data.cache && data.cache.search_cache) || {};
          const hits = (data.prometheus && data.prometheus.cache_hits_total) || null;
          const misses = (data.prometheus && data.prometheus.cache_misses_total) || null;
          const rate = hits || misses ? ((hits || 0) / Math.max((hits || 0) + (misses || 0), 1) * 100).toFixed(1) + "%" : "--";
          hitRateEl.textContent = rate;
          memUsedEl.textContent = cache.current_size ? `${cache.current_size} items` : "--";
          keysEl.textContent = cache.current_size ?? "--";
          ttlEl.textContent = cache.ttl ?? "--";
        } catch (err) {
          statusEl.textContent = `Failed to load stats: ${err.message}`;
        }
      };

      btnRefresh?.addEventListener("click", (e) => {
        e.preventDefault();
        refresh();
      });

      btnFlush?.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!confirm("Flush cache?")) return;
        try {
          const resp = await fetch("/api/admin/cache/flush", { method: "POST", headers: headers() });
          if (!resp.ok) throw new Error(resp.statusText);
          statusEl.textContent = "Caches flushed";
          refresh();
        } catch (err) {
          statusEl.textContent = `Flush failed: ${err.message}`;
        }
      });

      refresh();
    })();
  </script>
</body></html>
